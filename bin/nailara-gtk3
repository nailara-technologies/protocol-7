#!/usr/bin/perl

use strict;
use warnings;
use File::Spec;
use Cwd 'abs_path';
use FindBin qw($RealBin $RealScript);

### wrapper code to load Gtk3 module at compile time ###

BEGIN {
    ( my $local_lib_path = $0 ) =~ s|/[^/]+/[^/]+$|/lib/pm|;
    unshift( @INC, $local_lib_path ) if -d $local_lib_path;
}

my $agentname;
my @call_args = @ARGV;
my $exec_path = abs_path( File::Spec->catfile( $RealBin, $RealScript ) );
my $bin_path  = abs_path($RealBin);
my $perl_path = '/usr/bin/perl';
$perl_path = '/usr/local/bin/perl'
    if !-e $perl_path and -e '/usr/local/bin/perl';
chomp( $perl_path = qx(which perl) ) if !-e $perl_path;
die "[!] weird! perl binary not found" if !-e $perl_path;
my $nailara_path = File::Spec->catfile( $bin_path, 'nailara' );
die "[!] '$nailara_path': not found" if !-f $nailara_path;

if ( -l File::Spec->rel2abs($0) ) {
    $agentname = lc($0);
    $agentname =~ s/^.*nailara\.|[\. ]$//g;
    @call_args = ( $agentname, @ARGV );
}
$agentname //= 'nailara';
exec( $perl_path, '-C31', '-MGtk3', $nailara_path, @call_args )
    or die "failed to start $agentname agent: $!";
