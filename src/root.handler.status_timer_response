# >:]

# name = root.handler.status_timer_response

my $response    = shift;
my $instance_id = $response->{'params'}->{'instance_id'};
if ( not exists <root.agent.instance>->{$instance_id} ) {
    <[base.log]>->(
        1, "instance $instance_id is gone, skipping response timer!"
    );
    return;
}
my $instance      = <root.agent.instance>->{$instance_id};
my $is_core_agent = $instance->{'is_core'};
my $agent_name    = $instance->{'agent_name'};
my $fail_count    = $instance->{'ping'}->{'failures'}++;
my $ping_retry    = $fail_count ? 0 : 1;                     # retry once

$instance->{'timeout_timer'}->cancel
    if defined $instance->{'timeout_timer'}
    and !$instance->{'timeout_timer'}->is_cancelled;

if (    $response->{'cmd'} eq 'ACK'
    and $response->{'call_args'}->{'args'} eq 'pong' ) {     # all fine
    delete $instance->{'ping'}->{'failures'};
    <[base.log]>->(
        2, "instance $instance_id [$agent_name] ping response ( OK )"
    ) if !<debug.skip_root_ping>;

} elsif ( !$ping_retry ) {

    return if $instance->{'status'} eq 'failed';

    <[base.log]>->(
        0, "instance $instance_id [$agent_name] ping response ( FAIL )"
    );
    delete <callback.session.closing_last> if $is_core_agent; # for safe restart

    <[root.cancel_status_timer]>->($instance_id);
    $instance->{'ping'}->{'failures'} = 0;    # <- resetting fail counter
    <[agent.change_status]>->( $instance_id, 'failed' );

} else {
    <[base.log]>->(
        0,
        "instance $instance_id [$agent_name]"
            . " ping response ( FAIL ) (retrying..)"
    );

    # setting shorter ping timeout..
    $instance->{'timeout_timer'}->cancel
        if defined $instance->{'timeout_timer'}
        and $instance->{'timeout_timer'}->is_active;
    $instance->{'timeout_timer'} = <[event.add_timer]>->(
        {   'after' => $instance->{'ping'}->{'retry_timeout'} // 2,
            'handler' => 'root.handler.status_response_timeout',
            'data'    => $instance_id
        }
    );
}
