# >:]

# name  = root.agent.cmd.stop
# param = <agent_name(s)|instance(s)>
# descr = (manually) shutdown agent instance(s)

my $params = $$call{'args'} || '';
return { 'mode' => 'nack', 'data' => 'expected agent name or instance id' }
    if !length($params);

my $stop_mode
    = ( defined $$call{'mode'} and $$call{'mode'} eq 'implicit' )
    ? 'implicit'
    : 'manual';

my @instance_ids;
my $failed_name;
my $not_found   = 0;
my $setup_found = 0;
foreach my $param_str ( split / +/, $params ) {
    if ( $param_str =~ /^\d+$/ ) {    # instance id
        return {
            'mode' => 'nack',
            'data' => "unknown agent instance '$param_str' (see 'list agents')"
            }
            if not exists <root.agent.instance>->{$param_str};
        push( @instance_ids, $param_str );
    } else {                          # agent name ( XXX: validate syntax! )
        my $agent_name = $param_str;
        my $agent_subname;
        $agent_subname = $1 if $agent_name =~ s|\[([^\]]+)\]$||;
        my $agent_id = <[agent.get_id]>->($agent_name);
        if ( defined $agent_id ) { $setup_found++ }
        else { $not_found++; $failed_name //= $agent_name; next }
        foreach my $iid ( keys %{<root.agent.instance>} ) {
            next
                if defined $agent_subname
                and not exists <root.agent.instance>->{$iid}->{'subname'}
                or defined $agent_subname
                and exists <root.agent.instance>->{$iid}->{'subname'}
                and <root.agent.instance>->{$iid}->{'subname'} ne
                $agent_subname;

            push( @instance_ids, $iid )
                if <root.agent.instance>->{$iid}->{'agent_id'} == $agent_id;
        }
    }
}

map { <[agent.instance.stop]>->($_) } @instance_ids;

my $count   = scalar @instance_ids;
my $s       = $count > 1 ? 's' : '';
my $msg_str = "shutting down $count agent instance$s";

my %agent_names;
map {
    my $agent_name
        = <root.agent.setup>
        ->{ <root.agent.instance>->{$_}->{'agent_id'} }->{'name'};
    $agent_names{$agent_name}++;
} keys %{<root.agent.instance>};
my %shutdown_names;
map {
    my $agent_name
        = <root.agent.setup>
        ->{ <root.agent.instance>->{$_}->{'agent_id'} }->{'name'};
    <root.agent.instance>->{$_}->{'stopping'} = 1;
    $shutdown_names{$agent_name}++;
} @instance_ids;
foreach my $name ( keys %shutdown_names ) {
    if ( exists <root.agent.auto_cleanup>->{$name} ) {
        delete <root.agent.auto_cleanup>->{$name};
        delete <root.agent.auto_cleanup> if !keys %{<root.agent.auto_cleanup>};
    }
    my $instances_remaining = $agent_names{$name} - $shutdown_names{$name};
    if ( !$instances_remaining ) {

        my %agent_list;
        map { $agent_list{$_} = 1 } split / +/,
            <root.spawn_config.globals.agents.enabled>;
        delete $agent_list{$name};
        <root.spawn_config.globals.agents.enabled>
            = join( ' ', keys %agent_list );

        <root.agent.manually_stopped>->{$name} = <[base.time]>->(4)
            if $stop_mode eq 'manual';

        <[base.log]>->(
            1, "disabled agent '$name' (no more instances present)"
        );
        <[base.log]>->(
            1, ": <!> added '$name' to 'manually stopped' list <!>"
        ) if $stop_mode eq 'manual';

        next if not exists <root.agent.dependency>;
        foreach my $dep_name ( keys %{<root.agent.dependency>} ) {
            delete <root.agent.dependency>->{$dep_name}->{$name};
            if ( !keys %{ <root.agent.dependency>->{$dep_name} } ) {
                delete <root.agent.dependency>->{$dep_name};
                if ( exists <root.agent.auto_cleanup>->{$dep_name} ) {
                    <[base.log]>->(
                        1, "dependency based auto-start cleanup [$dep_name]"
                    );
                    <[agent.cmd.stop]>
                        ->( { 'args' => $dep_name, 'mode' => 'implicit' } );
                }
            }
        }
        delete <root.agent.dependency>
            if !keys( %{<root.agent.dependency>} );
    }
}

map { <[agent.change_status]>->( $_, 'shutdown' ) } @instance_ids;

return {
    'mode' => 'nack',
    'data' => "no agent '$failed_name' found in setup! (see 'list agents')"
    }
    if !$setup_found and $not_found;

if ($count) {
    return { 'mode' => 'ack', 'data' => $msg_str };
} else {
    return {
        'mode' => 'nack',
        'data' => 'there is no agent matching agent running'
    };
}
