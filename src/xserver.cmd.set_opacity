# >:]

# name  = xserver.cmd.set_opacity
# param = <w_id> <opacity>
# descr = set window opacity in percent [0..100]

my $X = <xserver.x11>;
my ( $window_id, $opacity ) = split( / +/, $$call{'args'} );

return { 'mode' => 'nack', 'data' => 'x11 window id required' }
    if not defined $window_id;
return { 'mode' => 'nack', 'data' => 'invalid x11 window id syntax' }
    if $window_id !~ /^\d+$/;
return { 'mode' => 'nack', 'data' => 'window <opacity> required' }
    if not defined $opacity;
return { 'mode' => 'nack', 'data' => 'invalid window <opacity> [0..100]' }
    if $opacity !~ /^\d+$/ or $opacity > 100;

my $xtops = <xserver.x11_tops>;
$xtops->update;

my $window;
for my $w ( @{ $xtops->sorted } ) {
    if ( $w->id eq $window_id ) {
        $window = $w;
        last;
    }
}

return { 'mode' => 'nack', 'data' => 'no such window' } if not defined $window;

<[base.log]>->( 2, "setting window $window_id opacity to $opacity%" );

my $result = <[xserver.set_window_opacity]>->( $window_id, $opacity / 100 );

<[base.log]>->(
    0, "error during set_opacity($opacity) for window $window_id [closed?]"
) if not defined $result;

return { 'mode' => 'ack', 'data' => "set opacity to $opacity%" };
