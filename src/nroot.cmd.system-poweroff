# >:]

# name  = nroot.cmd.system-poweroff
# param = [nosync]
# descr = force power off using sysrq-trigger [host]

my $param            = $$call{'args'} // '';
my $poweroff_enabled = <nroot.system-poweroff.enabled> //= 1;

return { 'mode' => 'nak', 'data' => "not found : '/proc/sysrq-trigger'" }
    if !-e '/proc/sysrq-trigger';
return {
    'mode' => 'nak',
    'data' => 'specifically disabled [ nroot.system-poweroff.enabled = 0 ]'
    }
    if not $poweroff_enabled;

<[base.log]>->( 0, "<!> <<< initiating force-poweroff >>> <!>" );

while ( keys %{ $data{'route'} } ) { <[event.once]>->(0.1) }  # wait log written

system('/bin/sync') if $param ne 'nosync';

<[event.add_timer]>->(
    {   'after'   => 0,
        'handler' => 'nroot.callback.system-poweroff'
    }
);

return { 'mode' => 'ack', 'data' => '<< powering off host system >>' }

# ______________________________________________________________________________
#\\FZQALEKYH2O6YNLUMBZVE2SC2J5Q6WVLK4TBAOHLTRS4YYVJR6AOWER5NQIPVRZOXG3DPYX2FRAPQ
# \\ IUAKSA7YJZBKTSMC5J7COIG33EQZIJ5QEMKU5OPC2MQ5QLVKQA56 \\// C25519-BASE-32 //
#  \\// VWXIZ22Z2ZJPLY6W3ED5FFSZLF2LLXZQM4XPXNCUVWPQRIHROBI \\ CODE SIGNATURE \\
#   ````````````````````````````````````````````````````````````````````````````
