# >:]

# name  = base.log
# descr = generate a log entry
# args  = log_level log_msg [log_buffer] [time-stamp]

my ( $log_level, $log_msg, $log_buffer, $time_stamp )
    = ( $_[0] || 0, $_[1] // '', $_[2] // '', $_[3] );

$log_level = 0 if $log_level !~ m|^\d+$|;

<system.verbosity.console>       //= 0;
<system.verbosity.agent_buffer>  //= 1;
<system.verbosity.agent_logfile> //= 0;

return 1
    if $log_level > <system.verbosity.console>
    and $log_level > <system.verbosity.agent_buffer>
    and $log_level > <system.verbosity.agent_logfile>;

$log_buffer = 'agent' if !length($log_buffer);

$log_msg = 'UNDEFINED LOG MESSAGE' if !length($log_msg);

my $h_override   = <base.ntime-harmony> // 1;  ## reducing calculation load., ##
my $want_harmony = $log_level < 3 ? $h_override : 0;

$log_msg =~ s|\r|\\r|g;
$log_msg =~ s|\n|\\n|g;
$log_msg =~ s|\0|\\0|g;
$log_msg =~ s|\e|\\e|g;

## prevent deep recursions in error log system ###
my $fatal_exit
    = ( $log_msg =~ m|Deep recursion | and $log_msg =~ m,log|buffer, ) ? 1 : 0;

$log_msg = "call to unknown subroutine while executing '$1'!"
    if $log_msg
    =~ m|\$code\{'([^\']*)'\}.+Can't use string \(""\) as a subroutine|;

my $dots = <log.dots> //= '.';

my $agent_prefix
    = sprintf( ":.%s.%s%s:", <system.node.name>, <system.agent.name>, $dots );

my $log_str;
if ( $log_level > 0 ) {
    $log_str = "$agent_prefix $log_msg";
} else {
    $log_str = "$agent_prefix $ANSI{bold}$ANSI{yelblue}$log_msg$ANSI{normal}";
}

if ($fatal_exit) {
    say STDERR $log_str, "$agent_prefix << EMERGENCY SHUTDOWN >> ",
        " [ anticipated deep recursion in log system ]";
    exit 2;
}

## write imto 'agent' log buffer ##
if ( defined $code{'base.buffer.add_line'} ) {
    $time_stamp //= $code{'base.anum_log_time'}->( 5, $want_harmony );
    <[base.buffer.add_line]>->(
        $log_buffer, join( ' ', $time_stamp, $log_level, $log_msg ), $log_level
        )
        if $log_level <= <system.verbosity.agent_buffer>
        or $log_level <= <system.verbosity.agent_logfile>;
}

# print to console

if ( fileno(STDOUT)
    and $log_level <= <system.verbosity.console> ) {

    say delete <log.next_console_line> if defined <log.next_console_line>;

    utf8::decode($log_str) and say $log_str;    ## <-- log to console ##

    <log.logged_prefix_width> = length($agent_prefix)
        if not defined <log.logged_prefix_width>
        or <log.logged_prefix_width> != length($agent_prefix);
}

return 1;

# ______________________________________________________________________________
#\\AY56FK5JDQ53O5S2NJ2Z3EALZWVUNNCWDR57ZLVYIZNIJ2V7XR4M7V5FBWCAZ2C7WJEKAT23CCXDY
# \\ STYHSNCMZOKLMPE26TB7SBLVMGWJQCVJYWJQ446FPNNQD2AIGWX4 \\// C25519-BASE-32 //
#  \\// DXX6LLBBL4572AQ4G552LM4LTCIJWHSLU4JBMY3YN2HXOIMF4AA \\ CODE SIGNATURE \\
#   ````````````````````````````````````````````````````````````````````````````
