# >:]

# name  = base.zenki.ondemand.handler.startup_reply
# descr = handles 'nroot.notify_online' command replies

my $reply = shift;

my $v_id       = $reply->{'params'}->{'v_id'};
my $zenka_name = <zenki.virtual>->{$v_id}->{'name'};
delete <zenki.virtual>->{$v_id}->{'starting'};

if ( $reply->{'cmd'} eq 'NAK' ) {
    my $reason = $reply->{'call_args'}->{'args'};
    <[base.log]>->(
        0, "on demand startup of zenka '$zenka_name' failed [ $reason ]"
    );
    while ( my $element = shift @{ <zenki.virtual>->{$v_id}->{'queue'} } ) {
        my $cmd_id = $element->{'cmd_id'};
        my $src_id = $element->{'source_id'};
        next if not exists $data{'session'}{$src_id};    ##   <--  gone.   ###

        $data{'session'}{$src_id}{'buffer'}{'output'}
            .= $cmd_id . "NAK command unknown\n";
    }
} else {
    <[base.log]>->( 1, "ondemand zenka '$zenka_name' now present.," );
    while ( my $element = shift @{ <zenki.virtual>->{$v_id}->{'queue'} } ) {
        my $src_id = $element->{'source_id'};
        next if not exists $data{'session'}{$src_id};    ##   <--  gone.   ###

        my $cmd_id = $element->{'cmd_id'};
        my $subname
            = defined $element->{'cmd_subname'}
            ? sprintf( "[%s]", $element->{'cmd_subname'} )
            : '';

        my $output_str = join( '',
            $cmd_id, $zenka_name, $subname, '.', $element->{'cmd_str'} );

        $output_str .= ' ' . $element->{'cmd_args'}
            if defined $element->{'cmd_args'};

        # [LLL] add multiline command parameters ..,

        $data{'session'}{$src_id}{'buffer'}{'input'} .= "$output_str\n";
    }
}

#.............................................................................
#ZNRI5ZNYJ674Y6QETF5IXTMAZXUP2JSQBWSQKMIWB2HGDW7YGOAMCCTT6H7K5KDHLTBQQ3GBGUQH6
#::: 6AQQYSSWSJIPN323PL4Z42OLB7HHSNKWOQT4GWK6ZQRLSYDHDXM :::: NAILARA AMOS :::
# :: TBSAY33DXVTCAYJ4GSMVQKZSJZVMRCIHV7PMCTAB7BNI6KIJ7MAI :: CODE SIGNATURE ::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
