## >:] ##

# name = X-11.handler.wait_visible

my $watcher       = shift->w;
my $id            = $watcher->data;
my $xtops         = <X-11.WM>;
my $wait_req      = <X-11.waiting>->{$id};
my $reply_id      = $wait_req->{'reply_id'};
my $title_pattern = $wait_req->{'pattern'};

if ( not defined $title_pattern ) {
    warn "[$id] title pattern not defined";
    <[X-11.cancel_wait_visible_timers]>->($wait_req);
    return;
}

$watcher->interval( sprintf( '%.4f', $watcher->interval() * 1.07 ) );

my $match_id;
foreach my $window_id (<[X-11.get_window_ids]>) {
    my $window_title = <[X-11.get_window_title]>->($window_id);
    if ( not defined $window_title ) {
        <[X-11.cancel_wait_visible_timers]>->($wait_req);
        <[base.callback.cmd_reply]>->(
            $reply_id,
            {   'mode' => qw| false |,
                'data' => 'window disappeared'
            }
        );
        delete <X-11.waiting>->{$id};
        return 0;
    }
    $match_id = $window_id and last if $window_title =~ $title_pattern;
}

#  if ($EVAL_ERROR) {
#      <[X-11.cancel_wait_visible_timers]>->($wait_req);
#      <[base.callback.cmd_reply]>->(
#          $reply_id,
#          {   'mode' => qw| false |,
#              'data' => 'lost connection to x-server'
#          }
#      );
#      delete <X-11.waiting>->{$id};
#      ## <[X-11.process-x11-error]>->($EVAL_ERROR);
#      return 0;
#  }

if ( length( $match_id // '' ) ) {

    <[X-11.cancel_wait_visible_timers]>->($wait_req);

    <[base.callback.cmd_reply]>->(
        $reply_id,
        {   'mode' => qw| true |,
            'data' => $match_id
        }
    );
    delete <X-11.waiting>->{$id};
    return 0;
} else {
    return 1;
}

#,,..,...,.,.,,,.,.,,,.,,,,,.,,,,,,.,,,.,,.,.,..,,...,..,,...,.,.,,,.,.,.,,,.,
#MQ75UPQR7LW43ETK7W4LQJASVPK5Y3B6DSIDEYPJEI3NOBFV6DWKCF73BPVD6T33JXICQB7GDIR7W
#\\\|FDJ36BV5NUUV5FMFMC4CU7OA3T7ZUQMMW4IXER6PPGBSYL4IWXB \ / AMOS7 \ YOURUM ::
#\[7]L4D6CAVO7V4SJETSVAUPVVKUIWPRNN2TLP2UDDKWJUGX73ENYCBY 7  DATA SIGNATURE ::
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
