# >:]

# name  = base.log
# descr = generate a log entry
# args  = log_level log_msg [log_buffer]

my $call = \$_[0];

my ( $log_level, $log_msg, $log_buffer ) = ( $_[0], $_[1], $_[2] );

$log_level = 0 if not defined $log_level or $log_level !~ /^\d+$/;
$log_msg = 'LOGMESSAGE UNDEFINED'
    if not defined $log_msg or !length($log_msg);
if ( not defined $log_buffer or $log_buffer eq '' ) { $log_buffer = 'system' }

$log_msg =~ s/\r/\\r/g;
$log_msg =~ s/\n/\\n/g;
$log_msg =~ s/\0/\\0/g;
$log_msg =~ s/\e/\\e/g;

# prevent deep recursions in error log system:
my $fatal_exit = 0;
$fatal_exit = 1
    if $log_msg =~ /Deep recursion / and $log_msg =~ /log|buffer/;

$log_msg = "call to unknown subroutine while executing '$1'!"
    if $log_msg
    =~ /\$code{'([^\']*)'}.+Can't use string \(""\) as a subroutine/;

my $log_txt;
my $agent_prefix = join( '.',
    ' :' . $data{'system'}{'node'}{'name'},
    $data{'system'}{'agent'}{'name'} );

if ( $log_level > 0 ) {
    $log_txt = "$agent_prefix $log_msg\n";
} else {
    $log_txt = "$agent_prefix $ANSI{bold}$log_msg$ANSI{normal}\n";
}

if ($fatal_exit) {
    print STDERR $log_txt
        . "$agent_prefix EMERGENCY SHUTDOWN!"
        . " [anticipated deep recursion in log system!]\n";
    exit 2;
}

my $log_stamp = join( ' ', <[base.time]>->(5), $log_level, $log_msg );

if (    defined $data{'system'}{'internal_verbosity'}
    and defined $log_level <= $data{'system'}{'internal_verbosity'} ) {
    <[base.buffer.add_line]>->( $log_buffer, $log_stamp );
}

if ( $log_level <= $data{'system'}{'verbosity'} ) {
    print $log_txt;

    # // testing ;) //

    #    $log_msg =~ s/\[[^\]]+\]//;

    #    <[base.proto.nailara.command.send.local]>->(
    #        {
    #            'command' => "say.text $log_msg",
    #            'reply' => { 'handler' => 'dev.null' }
    #        }
    #    );

}

