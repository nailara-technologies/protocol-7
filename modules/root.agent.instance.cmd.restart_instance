# >:]

# name  = root.agent.instance.cmd.restart_instance
# param = <id>
# descr = restart an agent instance

my $instance_id = $$call{'args'} || '';
my $error_msg;
$error_msg = 'no instance id specified' if !length($instance_id);
$error_msg = 'instance id is not numerical'
    if not defined $error_msg and $instance_id !~ /^\d+$/;
$error_msg = "instance $instance_id does not exist"
    if not defined $error_msg
    and not exists <root.agent.instance>->{$instance_id};
return { 'mode' => 'nack', 'data' => $error_msg } if defined $error_msg;

my $instance   = <root.agent.instance>->{$instance_id};
my $agent_name = $instance->{'agent_name'};

<[base.log]>->( 1, "restarting instance $instance_id ($agent_name)..." );

if ( exists $instance->{'status'} eq 'starting' ) {
    kill( 9, $instance->{'process'}->{'id'} );    # XXX: 15 + timeout
}
<[agent.change_status]>->( $instance_id, 'queued' );

return { 'mode' => 'ack', 'data' => "restarting instance $instance_id" };
