# >:]

# name  = auth.agent.client

my ( $filehandle, $agent, $key_str ) = @_;

if ( defined $key_str
    or %key
    and exists $key{'agent'}{'session_key'}
    and $key{'agent'}{'session_key'} ne '' ) {
    $key_str //= $key{'agent'}{'session_key'};
    my $smiley;
    if ( sysread( $filehandle, $smiley, 4 ) ) {
        if ( $smiley =~ />:\]\n/ ) {
            <[base.log]>->( 1, "[*] protocol banner detected.." );
        } else {
            <[base.log]>->( 0, "[#] some strange backendserver found!" );
            exit(1);
        }
    }

    <[net.out]>->( $filehandle, "select agent\n" );

    my $answer = readline($filehandle);

    <[net.out]>->( $filehandle, "$agent $key_str\n" );
    delete $key{'agent'}{'session_key'} if exists $key{'agent'}{'session_key'};

    if ( read( $filehandle, $answer, 8 ) ) {

        if ( $answer =~ /YEAH/ ) {
            <[base.log]>->( 1, "[*] successfully authenticated :)" );
            return $filehandle;
        } elsif ( $answer =~ /FAIL/ ) {
            <[base.log]>->( 0, "[#] access denied :(" );
            return undef;
        } else {
            <[base.log]>->( 0, "[#] protocol error :(" );
            return undef;
        }
    }
} else {
    <[base.log]>->(
        0, "auth.agent.client: session_key not defined. authentication failed."
    );
    return undef;
}
