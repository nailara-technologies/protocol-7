# >:]

# name  = root.set_up_agent_dependencies
# descr = configures agent dependency chains

my @agents = @_;

if ( !@agents ) {
    <[base.log]>->(
        0, 'root.set_up_agent_dependencies: no agent list provided'
    );
    return;
}

<[base.log]>->( 1, 'setting up agent dependency chains..' );

foreach my $agent_name (@agents) {

    <[base.log]>->( 2, ": setting up agent '$agent_name'" );

    # install agent setup data
    my $agent_id = <[root.agent.setup.add]>->( { 'name' => $agent_name } );

    # create dependency objects for the agents
    <[dependency.add_object]>->(
        {   'type'       => 'agent',
            'agent_id'   => $agent_id,
            'agent_name' => $agent_name,
        }
    );
}

# set up agent dependencies

foreach my $id ( keys( %{<root.agent.setup>} ) ) {
    my $agent_name   = <root.agent.setup>->{$id}->{'name'};
    my $dependencies = <[root.agent.get_dependencies]>->($agent_name);
    next if not defined $dependencies;

    my $source_object;
    foreach my $object_id ( keys( %{<dependency.objects>} ) ) {
        my $element = <dependency.objects>->{$object_id};
        if ( $element->{'agent_id'} == $id ) {
            $source_object = $object_id;
            last;
        }
    }

    foreach my $dep_agent_name ( split / +/, $dependencies ) {

        # choosing first agent with such a name (for now) multiple comes later..
        my $first_id;
        foreach my $agent_id ( keys %{<root.agent.setup>} ) {
            if ( <root.agent.setup>->{$agent_id}->{'name'} eq $dep_agent_name )
            {
                $first_id = $agent_id;
                last;
            }
        }

        # getting the object id for this agent id
        my $object_id;
        foreach my $id ( keys( %{<dependency.objects>} ) ) {
            my $element = <dependency.objects>->{$id};
            if ( $element->{'agent_id'} == $first_id ) {
                $object_id = $id;
                last;
            }
        }

        # add the object id to the dependency chain
        <[dependency.add]>->( $source_object, $object_id );
    }
}
