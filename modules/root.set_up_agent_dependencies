# >:]

# name  = root.set_up_agent_dependencies
# descr = configures agent dependency chains

my @agents = @_;

if ( !@agents ) {
    <[base.log]>->(
        0, 'root.set_up_agent_dependencies: no agent list provided'
    );
    return;
}

# set up callback for checking agent dependency fullfillment status
<[dependency.setup]>->(
    'agent',
    {   'callback' => sub {
            my $object_id = shift;
            return undef if not exists <dependency.object>->{$object_id};
            my $agent_id = <dependency.object>->{$object_id}->{'agent_id'};
            return undef if not exists <root.agent.setup>->{$agent_id};
            foreach my $id ( keys %{<root.agent.instance>} ) {
                return 1
                    if <root.agent.instance>->{$id}->{'agent_id'} == $agent_id
                    and <root.agent.instance>->{$id}->{status} eq 'online';
            }
            return 0;    # not online
        }
    }
);

foreach my $agent_name (@agents) {

    <[base.log]>->( 2, ": dependency object : agent '$agent_name'" );

    # install agent setup data
    my $agent_id = <[agent.setup.add]>->( { 'name' => $agent_name } );

    # create dependency objects for the agents
    <[dependency.add_object]>->(
        {   'type'       => 'agent',
            'agent_id'   => $agent_id,
            'agent_name' => $agent_name,
        }
    );
}

<[base.log]>->( 1, 'setting up agent dependency chains ...' );

foreach my $s_id (
    sort {
        <root.agent.setup>->{$a}->{'name'} cmp
            <root.agent.setup>->{$b}->{'name'}
    } keys( %{<root.agent.setup>} )
    ) {
    my $agent_name   = <root.agent.setup>->{$s_id}->{'name'};
    my $dependencies = <[agent.get_dependencies]>->($agent_name);
    next if not defined $dependencies;

    <[base.log]>->( 2, ": agent '$agent_name' dependencies [ $dependencies ]" );

    my $source_object = <[agent.get_object_id]>->($s_id);

    foreach my $dep_agent_name ( split / +/, $dependencies ) {

        # choosing first agent with such a name (for now) multiple comes later..
        my $first_id  = <[agent.get_id]>->($dep_agent_name);
        my $object_id = <[agent.get_object_id]>->($first_id);

        <[dependency.add]>->( $source_object, $object_id );
    }
}
