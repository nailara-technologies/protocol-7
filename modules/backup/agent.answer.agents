# >:]

# name       = agent.answer.agents

my ( $cmd, $params ) = ( ${ $_[0] }{'cmd'}, ${ $_[0] }{'params'} );

my $agent_name = $$params{'agent_name'};
my $agent_id   = $$params{'agent_id'};

print "agent: '$agent_name'\nstatus: "
  . $data{'agent'}{$agent_id}{'status'} . "\n";

if ( $cmd =~ /^NACK/ ) {

    if ( $data{'agent'}{$agent_id}{'status'} ne 'agent' ) {

        $data{'agent'}{$agent_id}{'status'} = 'agent';

        my $ok     = 0;
        my $failed = 0;

        if ( <[agent.run]>->($agent_name) ) {
            $ok++;
        }
        else {
            $failed++;
        }

	print "PASS 1\n";

        if ( !$failed ) {

	    print "::: TRUE\n";

	    return \{
                'mode' => 'ack',
                'data' => 'all agents spawned sucessfully'
            };
        }
        else {
            my $txt = $failed . ' agents reported errors';

	    print "FALSE\n";

            return \{ 'mode' => 'nack', 'data' => $txt };
        }
    }

}
elsif ( $cmd =~ /^ACK$/ ) {

    $data{'agent'}{$agent_id}{'status'} = 'online';

    #    $data{'agent'}{$agent_id}{'id'}     = $id;
}
elsif ( $answer eq '' ) {
    <[base.log]>->( 0, 'no answer from core' );
}
else { <[base.log]>->( 0, "unknown answer: '$answer'" ); }
