# >:]

# name = root.handler.agent_status

my ( $instance_id, $status ) = @_;
die "no instance id specified" if not defined $instance_id;
die "no status submitted"      if not defined $status;
die "no such agent instance ($instance_id)"
    if not exists <root.agent.instance>
    or not exists <root.agent.instance>->{$instance_id};

my $instance   = <root.agent.instance>->{$instance_id};
my $agent_id   = $instance->{'agent_id'};
my $agent_name = <root.agent.setup>->{$agent_id}->{'name'};
my $job_id     = $instance->{'job_id'};

$instance->{'status'} = $status;

<[base.log]>->( 1, "agent_status: '$agent_name', status: '$status'" );

# move job if required ... XXX: refine!
my $target_queue;
$target_queue = 'running' if $status eq 'online';
$target_queue = 'failed' if $status eq 'failed' or $status eq 'offline';
<[jobqueue.move_job]>->( $instance->{'job_id'}, $target_queue )
    if defined $target_queue;

<[jobqueue.check_dependencies]>;
