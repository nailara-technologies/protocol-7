# >:]

# name = root.handler.status_timer_response

my $response    = shift;
my $instance_id = $response->{'params'}->{'instance_id'};
if ( not exists <root.agent.instance>->{$instance_id} ) {
    <[base.log]>->(
        1, "instance $instance_id is gone, skipping response timer!"
    );
    return;
}
my $instance      = <root.agent.instance>->{$instance_id};
my $is_core_agent = $instance->{'is_core'};
my $agent_name    = $instance->{'agent_name'};

$instance->{'timeout_timer'}->cancel;

if (    $response->{'cmd'} eq 'ACK'
    and $response->{'call_args'}->{'args'} eq 'pong' ) {    # all fine
    <[base.log]>
        ->( 2, "instance $instance_id [$agent_name] response.. ( ok )" );
    $instance->{'status_timer'}->again
        if !$instance->{'status_timer'}->is_cancelled;
} else {
    <[base.log]>->(
        0, "instance $instance_id [$agent_name] response.. ( FAIL )"
    );
    delete <callback.session.close_last> if $is_core_agent; # allow safe restart
    <[agent.change_status]>->( $instance_id, 'failed' );
}
