 # >:]

# name       = net.out

# print ">>\n";

if ( fileno $_[0] ) {
    if ( defined $data{'handle'}{ $_[0] }
        and defined $data{'session'}{ $data{'handle'}{ $_[0] }{'cid'} }
        {'output'}{'handler'} )
    {
        if (
            defined &{ $code{ $data{'session'}{ $data{'handle'}{ $_[0] }{'cid'} }
            {'output'}{'handler'} } } )
        {
            syswrite( $_[0],
                &{ $code{ $data{'session'}{ $data{'handle'}{ $_[0] }{'cid'} }
                {'output'}{'handler'} } } ( $_[1] ) );
        }
        else {
            &{ $code{'base.log'} }
              (0,"[$_[0]] output chain handler is not valid! ..deleted.");
            $data{'session'}{ $data{'handle'}{ $_[0] }{'cid'} }
              {'output'}{'handler'} = undef;
    #        $data{'session'}{$id}{'die_msg'} = "BYE filter chain error";
    #        $data{'session'}{$id}{'die'}     = 'yes';
            return 1;
        }
    }
    else { syswrite( $_[0], $_[1] ) }

    #   print "<<\n";

    if ( $data{'handle'}{ $_[0] }{'cid'} ) {
        $data{'session'}{ $data{'handle'}{ $_[0] }{'cid'} }{'bytes'}{'in'} +=
          length( $_[1] );
    }
    else {
        $data{'handle'}{ $_[0] }{'bytes'}{'in'} += length( $_[1] );
    }
    return 0;
}
else { &{ $code{'base.log'} } ( 0, "[$_[0]] can not send to socket"); return 1 }
