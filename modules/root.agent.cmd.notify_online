# >:]

# name  = root.agent.cmd.notify_online
# param = <agent|instance>
# descr = reply when agent startup complete or failed

<root.agent.notify_online> //= {};

my $query_param = $$call{'args'};
my $reply_id    = $$call{'reply_id'};

return { 'mode' => 'nack', 'data' => 'expected agent name parameter' }
    if not defined $query_param or !length($query_param);

if ( $query_param =~ /^job:(\d+)$/ and my $job_id = $1 ) {
    my $instance_id;
    map {
        $instance_id = $_
            if <root.agent.instance>->{$_}->{'job_id'} == $job_id
    } keys %{<root.agent.instance>};
    if ( defined $instance_id ) {
        $query_param = $instance_id;
    } else {
        return {
            'mode' => 'nack',
            'data' => "unknown job id '$job_id'"
        };
    }
}

if (    not defined <[agent.get_id]>->($query_param)
    and not defined <root.agent.instance>->{$query_param} ) {
    my $rep_msg
        = $query_param =~ /^\d+$/
        ? "no such agent instance ($query_param)"
        : "no such agent in setup [$query_param]";
    return {
        'mode' => 'nack',
        'data' => $rep_msg
    };
}

foreach my $id ( keys %{<root.agent.instance>} ) {
    return {
        'mode' => 'ack',
        'data' => "agent '$query_param' already online!"
        }
        if <root.agent.instance>->{$id}->{'agent_name'} eq $query_param
        and <root.agent.instance>->{$id}->{'status'} eq 'online';
}

if ( $query_param =~ /^(\d+)$/ and my $id = $1 ) {    # instance id
    return {
        'mode' => 'ack',
        'data' => "agent instance '$id' already online!"
        }
        if defined <root.agent.instance>->{$id}
        and <root.agent.instance>->{$id}->{'status'} eq 'online';
}

<[base.log]>->(
    2, "startup notification request fot agent '$query_param' received"
);

push( @{ <root.agent.notify_online>->{$query_param} }, $reply_id );

return { 'mode' => 'later' }
